// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Vehicle {
  id                String      @id @default(cuid())
  licensePlate      String      @unique
  vehicleType       String      @default("STANDARD") // COMPACT, STANDARD, OVERSIZED
  rateType          String      @default("HOURLY")   // HOURLY, DAILY, MONTHLY, SPECIAL
  spotId            String?
  ownerId           String?     // References User.id when vehicle is owned by registered user
  ownerName         String?
  ownerEmail        String?
  ownerPhone        String?
  make              String?
  model             String?
  year              Int?
  color             String?
  checkInTime       DateTime    @default(now())
  checkOutTime      DateTime?
  isPaid            Boolean     @default(false)
  hourlyRate        Float       @default(5.0)
  totalAmount       Float       @default(0.0)
  amountPaid        Float       @default(0.0)
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  sessions          ParkingSession[]
  spot              ParkingSpot?    @relation(fields: [spotId], references: [id])
  owner             User?           @relation(fields: [ownerId], references: [id])

  // Performance indexes
  @@index([licensePlate])
  @@index([spotId])
  @@index([ownerId])
  @@index([vehicleType])
  @@index([checkInTime])
  @@index([isPaid])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([spotId, isPaid])
  @@index([vehicleType, checkInTime])
  @@index([ownerId, checkInTime])
  @@index([checkInTime, checkOutTime])
  @@map("vehicles")
}

model ParkingSpot {
  id          String      @id @default(cuid())
  spotNumber  String      @unique
  level       Int
  section     String?
  spotType    String      @default("STANDARD") // COMPACT, STANDARD, OVERSIZED, HANDICAP, ELECTRIC
  status      String      @default("AVAILABLE") // AVAILABLE, OCCUPIED, RESERVED, MAINTENANCE, OUT_OF_ORDER
  isActive    Boolean     @default(true)
  width       Float?
  length      Float?
  height      Float?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  vehicles    Vehicle[]
  sessions    ParkingSession[]

  // Performance indexes
  @@index([spotNumber])
  @@index([status])
  @@index([spotType])
  @@index([level])
  @@index([isActive])
  // Composite indexes for common queries
  @@index([status, spotType])
  @@index([level, section])
  @@index([spotType, isActive])
  @@map("parking_spots")
}

model ParkingSession {
  id              String      @id @default(cuid())
  vehicleId       String
  spotId          String
  startTime       DateTime    @default(now())
  endTime         DateTime?
  duration        Int?        // Duration in minutes
  hourlyRate      Float       @default(5.0)
  totalAmount     Float       @default(0.0)
  amountPaid      Float       @default(0.0)
  isPaid          Boolean     @default(false)
  paymentMethod   String?     // CASH, CREDIT_CARD, DEBIT_CARD, MOBILE_PAY, APP_PAYMENT
  paymentTime     DateTime?
  status          String      @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED, OVERSTAYED
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  vehicle         Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  spot            ParkingSpot @relation(fields: [spotId], references: [id])

  // Performance indexes
  @@index([vehicleId])
  @@index([spotId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([isPaid])
  @@index([paymentTime])
  // Composite indexes for analytics and reporting
  @@index([startTime, endTime])
  @@index([status, isPaid])
  @@index([vehicleId, startTime])
  @@index([spotId, startTime])
  @@index([paymentTime, totalAmount])
  @@map("parking_sessions")
}

model Garage {
  id              String    @id @default(cuid())
  name            String
  address         String?
  city            String?
  state           String?
  zipCode         String?
  totalSpots      Int       @default(0)
  availableSpots  Int       @default(0)
  hourlyRate      Float     @default(5.0)
  isActive        Boolean   @default(true)
  openTime        String?   // Time format: "08:00"
  closeTime       String?   // Time format: "22:00"
  timezone        String    @default("UTC")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Performance indexes
  @@index([isActive])
  @@index([city, state])
  @@index([totalSpots, availableSpots])
  @@map("garages")
}

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  role              String      @default("USER") // USER, ADMIN, MANAGER, OPERATOR
  isActive          Boolean     @default(true)
  isEmailVerified   Boolean     @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  passwordResetToken String?
  passwordResetExpires DateTime?
  lastLoginAt       DateTime?
  loginAttempts     Int         @default(0)
  lockoutUntil      DateTime?
  twoFactorSecret   String?
  isTwoFactorEnabled Boolean    @default(false)
  twoFactorBackupCodes String?  // JSON array of backup codes
  lastPasswordChange DateTime?  @default(now())
  passwordChangeRequired Boolean @default(false)
  securityQuestionHash String?
  securityAnswerHash String?
  preferredLanguage String      @default("en")
  timezone          String      @default("UTC")
  phoneNumber       String?
  isPhoneVerified   Boolean     @default(false)
  phoneVerificationToken String?
  phoneVerificationExpires DateTime?
  googleId          String?     @unique
  githubId          String?     @unique
  profileImageUrl   String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  vehicles          Vehicle[]   // User can own multiple vehicles
  sessions          UserSession[]
  auditLogs         SecurityAuditLog[]
  devices           UserDevice[]
  loginHistory      LoginHistory[]

  // Performance indexes
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([lastLoginAt])
  @@index([loginAttempts, lockoutUntil])
  @@index([googleId])
  @@index([githubId])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@map("users")
}

model UserSession {
  id                String      @id @default(cuid())
  userId            String
  token             String      @unique
  refreshToken      String?     @unique
  expiresAt         DateTime
  refreshExpiresAt  DateTime?
  isRevoked         Boolean     @default(false)
  deviceInfo        String?     // User agent/device information
  deviceFingerprint String?
  ipAddress         String?
  geoLocation       String?     // City, Country from IP
  lastActivityAt    DateTime    @default(now())
  sessionType       String      @default("WEB") // WEB, MOBILE, API
  csrfToken         String?
  revokedReason     String?     // LOGOUT, SECURITY, EXPIRED, ADMIN
  revokedAt         DateTime?
  isSecure          Boolean     @default(false) // HTTPS connection
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device            UserDevice? @relation(fields: [deviceFingerprint], references: [fingerprint])

  // Performance indexes
  @@index([userId])
  @@index([token])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([isRevoked])
  @@index([deviceFingerprint])
  @@index([ipAddress])
  @@index([lastActivityAt])
  @@index([userId, isRevoked, expiresAt])
  @@map("user_sessions")
}

model UserDevice {
  id              String      @id @default(cuid())
  userId          String
  fingerprint     String      @unique // Device fingerprint hash
  name            String?     // User-assigned device name
  deviceType      String      // DESKTOP, MOBILE, TABLET
  browser         String?
  operatingSystem String?
  ipAddress       String?
  geoLocation     String?
  isTrusted       Boolean     @default(false)
  lastSeenAt      DateTime    @default(now())
  firstSeenAt     DateTime    @default(now())
  isActive        Boolean     @default(true)
  notificationSettings String? // JSON string for push notification preferences
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        UserSession[]
  loginHistory    LoginHistory[]

  // Performance indexes
  @@index([userId])
  @@index([fingerprint])
  @@index([isTrusted])
  @@index([isActive])
  @@index([lastSeenAt])
  @@index([userId, isActive])
  @@map("user_devices")
}

model LoginHistory {
  id              String      @id @default(cuid())
  userId          String
  deviceId        String?
  attemptType     String      // SUCCESS, FAILED_PASSWORD, FAILED_2FA, BLOCKED
  ipAddress       String
  geoLocation     String?
  userAgent       String?
  failureReason   String?     // INVALID_PASSWORD, ACCOUNT_LOCKED, 2FA_REQUIRED, etc.
  isSuspicious    Boolean     @default(false)
  riskScore       Float?      // 0.0 to 1.0 risk assessment
  metadata        String?     // JSON string for additional context data
  createdAt       DateTime    @default(now())

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device          UserDevice? @relation(fields: [deviceId], references: [id])

  // Performance indexes
  @@index([userId])
  @@index([attemptType])
  @@index([ipAddress])
  @@index([isSuspicious])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([ipAddress, createdAt])
  @@index([attemptType, createdAt])
  @@map("login_history")
}

model SecurityAuditLog {
  id              String      @id @default(cuid())
  userId          String?
  sessionId       String?
  action          String      // LOGIN, LOGOUT, PASSWORD_CHANGE, 2FA_ENABLE, etc.
  category        String      // AUTH, ACCOUNT, SECURITY, DATA_ACCESS
  severity        String      // LOW, MEDIUM, HIGH, CRITICAL
  description     String
  ipAddress       String?
  userAgent       String?
  metadata        String?     // JSON string for additional context data
  riskLevel       String?     // LOW, MEDIUM, HIGH, CRITICAL
  isAnomaly       Boolean     @default(false)
  createdAt       DateTime    @default(now())

  // Relations
  user            User?       @relation(fields: [userId], references: [id])

  // Performance indexes
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([createdAt])
  @@index([isAnomaly])
  @@index([riskLevel])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([severity, createdAt])
  @@map("security_audit_logs")
}

model EmailTemplate {
  id              String      @id @default(cuid())
  name            String      @unique // VERIFICATION, RESET_PASSWORD, 2FA_ENABLED, etc.
  subject         String
  htmlContent     String
  textContent     String
  variables       String?     // JSON string for template variables schema
  isActive        Boolean     @default(true)
  language        String      @default("en")
  version         Int         @default(1)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Performance indexes
  @@index([name])
  @@index([isActive])
  @@index([language])
  @@map("email_templates")
}

model SecuritySettings {
  id                        String      @id @default(cuid())
  key                       String      @unique
  value                     String
  dataType                  String      // STRING, NUMBER, BOOLEAN, JSON
  category                  String      // AUTH, SESSION, SECURITY, EMAIL
  description               String?
  isEditable                Boolean     @default(true)
  environmentSpecific       Boolean     @default(false)
  lastModifiedBy            String?
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt

  // Performance indexes
  @@index([key])
  @@index([category])
  @@index([environmentSpecific])
  @@map("security_settings")
}