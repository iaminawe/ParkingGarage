---
name: Repository Migration & Updates
status: open
created: 2025-09-02T18:00:10Z
updated: 2025-09-02T18:10:16Z
github: https://github.com/iaminawe/ParkingGarage/issues/52
depends_on: [50]
parallel: false
conflicts_with: []
---

# Task 52: Repository Migration & Updates

## Overview
Migrate all repository classes (Garage, Spot, Vehicle, Session, Payment) from direct SQLite queries to use Prisma ORM while maintaining backward compatibility with existing interfaces and implementing proper error handling.

## Technical Requirements

### Repository Classes to Update
1. **GarageRepository** (`src/domain/repositories/GarageRepository.js`)
2. **SpotRepository** (`src/domain/repositories/SpotRepository.js`)
3. **VehicleRepository** (`src/domain/repositories/VehicleRepository.js`)
4. **SessionRepository** (`src/domain/repositories/SessionRepository.js`)
5. **PaymentRepository** (`src/domain/repositories/PaymentRepository.js`)

### Implementation Details

#### Prisma Client Integration
- Replace all `this.db` SQLite calls with Prisma client operations
- Use Prisma's type-safe queries and mutations
- Implement proper connection management
- Add connection pooling configuration

#### Error Handling Strategy
```javascript
// Standard error handling pattern
try {
  const result = await this.prisma.garage.create({
    data: garageData
  });
  return result;
} catch (error) {
  if (error.code === 'P2002') {
    throw new DuplicateError('Garage already exists');
  }
  throw new DatabaseError(`Failed to create garage: ${error.message}`);
}
```

#### Backward Compatibility
- Maintain existing method signatures
- Preserve return data structures
- Keep existing validation logic
- Ensure tests continue to pass

### Specific Migration Tasks

#### 1. GarageRepository Migration
- `create()` - Use `prisma.garage.create()`
- `findById()` - Use `prisma.garage.findUnique()`
- `findAll()` - Use `prisma.garage.findMany()`
- `update()` - Use `prisma.garage.update()`
- `delete()` - Use `prisma.garage.delete()`
- `findByAddress()` - Custom query with `where` clause

#### 2. SpotRepository Migration
- `create()` - Include garage relation
- `findByGarage()` - Use relation queries
- `findAvailable()` - Complex where conditions
- `updateStatus()` - Atomic status updates
- `bulkCreate()` - Use `createMany()`

#### 3. VehicleRepository Migration
- `create()` - Handle license plate uniqueness
- `findByLicense()` - Unique constraint queries
- `findByOwner()` - Owner-based filtering
- `updateInfo()` - Partial updates

#### 4. SessionRepository Migration
- `create()` - Include vehicle and spot relations
- `findActive()` - Status-based queries
- `findByVehicle()` - Relation-based queries
- `endSession()` - Update with timestamps
- `findByDateRange()` - Date filtering

#### 5. PaymentRepository Migration
- `create()` - Include session relations
- `findBySession()` - Foreign key queries
- `findPending()` - Status filtering
- `updateStatus()` - Payment state management
- `findByDateRange()` - Financial reporting queries

## Acceptance Criteria

### Functional Requirements
- [ ] All repository methods use Prisma instead of raw SQLite
- [ ] Existing API endpoints continue to work without changes
- [ ] All existing unit tests pass
- [ ] No breaking changes to method signatures
- [ ] Performance is equal or better than current implementation

### Error Handling
- [ ] Prisma errors are properly caught and transformed
- [ ] Custom error types are thrown for known scenarios
- [ ] Database connection errors are handled gracefully
- [ ] Constraint violations return meaningful error messages

### Code Quality
- [ ] All methods have proper TypeScript/JSDoc annotations
- [ ] Error handling follows established patterns
- [ ] No code duplication between repositories
- [ ] Consistent naming conventions used

### Testing Requirements
- [ ] Unit tests updated to work with Prisma
- [ ] Integration tests verify database operations
- [ ] Error scenarios are tested
- [ ] Performance benchmarks maintained

## Implementation Steps

1. **Setup Phase**
   - Import Prisma client in each repository
   - Initialize client connection management
   - Setup error handling utilities

2. **Migration Phase**
   - Update one repository at a time
   - Run tests after each repository migration
   - Verify functionality with integration tests

3. **Validation Phase**
   - Run full test suite
   - Performance testing
   - Error handling verification

4. **Cleanup Phase**
   - Remove old SQLite query code
   - Update documentation
   - Code review and optimization

## Dependencies
- **Depends on**: Task 50 (Prisma Schema & Database Setup)
- **Blocks**: Task 53 (Transaction Support Implementation)

## Definition of Done
- [ ] All 5 repositories migrated to Prisma
- [ ] 100% test coverage maintained
- [ ] No breaking changes introduced
- [ ] Performance benchmarks met or exceeded
- [ ] Code review completed and approved
- [ ] Documentation updated
- [ ] Integration tests pass in CI/CD

## Effort Estimate
**8 hours** - Complex migration requiring careful testing and validation

## Risk Mitigation
- Migrate one repository at a time to minimize risk
- Maintain comprehensive test coverage
- Use feature flags for gradual rollout if needed
- Have rollback plan with database backups
